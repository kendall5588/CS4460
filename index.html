<!DOCTYPE html>
<meta charset="utf-8">
<head>
	<link rel="stylesheet" href="http://code.jquery.com/mobile/1.4.4/jquery.mobile-1.4.4.min.css">
	<script src="http://code.jquery.com/jquery-1.11.1.min.js"></script>
	<script src="http://code.jquery.com/mobile/1.4.4/jquery.mobile-1.4.4.min.js"></script>
	<style>
		#graphPanel.ui-panel {
			width: 25em;
		}
		.state{
	  		fill: none;
	  		stroke: #fff;
		}
		
		.state:hover{
			fill-opacity:0.5;
		}
		
		#tooltip {   
			position: absolute;           
			text-align: center;
			padding: 20px;             
			margin: 10px;
			font: 12px sans-serif;        
			background: lightsteelblue;   
			border: 1px;      
			border-radius: 2px;           
			pointer-events: none;         
		}
		
		#tooltip h4{
			margin:0;
			font-size:14px;
		}
		
		#tooltip{
			background:rgba(0,0,0,0.9);
			border:1px solid grey;
			border-radius:5px;
			font-size:12px;
			width:auto;
			padding:4px;
			color:white;
			opacity:0;
		}
		
		#tooltip table{
			table-layout:fixed;
		}
		
		#tooltip tr td{
			padding:0;
			margin:0;
		}
		
		#tooltip tr td:nth-child(1){
			width:50px;
		}
		
		#tooltip tr td:nth-child(2){
			text-align:center;
		}
		
		.chart text {
		  fill: white;
		  font: 12px sans-serif;
		  text-anchor: middle;
		}
	</style>
</head>

<body>
	<h1 style = "text-indent: 7em">SAT/State Education Visualization</h1>
	<div id = "mainScreen">
		<p style = "text-indent: 30em"><a href="#graphPanel"  onclick = "addPic()">Click me</a></p>
		<div data-role="panel" data-position="right" data-display = "reveal" id="graphPanel"> 
		    <h2>Panel Header</h2>
		    <p><div id = "panelPic">
		    </div></p>
		 </div> 
		<div id="tooltip"></div>
		<svg width="960" height="600" id="statesvg">
	      	<g transform="translate(910,400)">
	      		<svg class="chart" width="420" height="120"></svg>
	      	</g>
		</svg>
		
		<script src="lib/d3.js"></script>
		<script src="js/stateBorders.js"></script>
		<script src="js/map.js"></script>

		<script>
			var width = 35,
	    		barHeight = 35;
				scores = {};
				states = ["AL", "AK", "AZ", "AR", "CA", "CO", "CT", "DC", "DE", "FL", "GA",
			              "HI", "ID", "IL", "IN", "IA", "KS", "KY", "LA", "ME", "MD", 
			              "MA", "MI", "MN", "MS", "MO", "MT", "NE", "NV", "NH", "NJ",
			              "NM", "NY", "NC", "ND", "OH", "OK", "OR", "PA", "RI", "SC",
			              "SD", "TN", "TX", "UT", "VT", "VA", "WA", "WV", "WI", "WY"];
			var x = d3.scale.ordinal()
			    .rangeRoundBands([0, width], .1);
				
			var color = d3.scale.ordinal()
				.range(["#98abc5", "#8a89a6", "#7b6888", "#6b486b", "#a05d56", "#d0743c", "#ff8c00"]);
			console.log(color);
			//default data reading
			d3.csv("res/default.csv", function(error, data) {
				var min = parseInt(d3.min(data, function(d) { return d.totalScore; }));
					max = parseInt(d3.max(data, function(d) { return d.totalScore; }));
					dif = max - min;
					scale = [max, Math.round(min+dif*.75), Math.round(min+dif*.5),
					         Math.round(min+dif*.25), min]
					var temp = getColor(scale, min, max);
					
				for (var index = 0; index < data.length; ++index) {
					data[index].totalScore = +data[index].totalScore;
					var color = 255 * (data[index].totalScore - min)/(max - min);
					scores[states[index]] = {score:data[index].totalScore, color:d3.rgb(color,0,0)};
				}
				
				//draw map
				map.draw("#statesvg", scores, tooltip);
				
				//draw scale
				var x = d3.scale.linear()
				    .domain([0, max])
				    .range([0, width]);

				var chart = d3.select(".chart")
				    .attr("width", width)
				    .attr("height", barHeight * scale.length);

				var bar = chart.selectAll("g")
				    .data(scale)
				  .enter().append("g")
				    .attr("transform", function(d, i) { return "translate(0," + i * barHeight + ")"; });

				bar.append("rect")
				    .attr("width", width)
				    .style("fill", x)
				    .attr("height", barHeight);
				    
				bar.append("text")
				    .attr("x", width / 2 - 1)
				    .attr("y", barHeight / 2)
				    .attr("dy", ".35em")
				    .text(function(d) { return d; });
			});
			
			//functions
			function getColor(a, min, max) {
				var ret = [];
				for (var i = 0; i < a.length; i++) {
					ret[i] = d3.rgb(255 * (a[i] - min)/(max - min), 0, 0)
				}
				return ret;
				//return d3.rgb(255 * (a - min)/(max - min), 0, 0);
			}
			function addPic(){
				var imgURL = "http://conches.typepad.com/.a/6a00e008d46c2c8834015393733c74970b-pi";
				var e = document.getElementById("panelPic");
				e.innerHTML = '<p><img src ="' + imgURL + '">';
			}			
			function tooltip(n, d){
				return "<h4>"+n+"</h4><table><tr><td>Score</td><td>"+(d.score)+"</td></tr></table>";
			}
		</script>
	</div>
</body>