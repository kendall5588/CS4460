<!DOCTYPE html>
<meta charset="utf-8">
<head>
	<link rel="stylesheet" href="http://code.jquery.com/mobile/1.4.4/jquery.mobile-1.4.4.min.css">
	<script src="http://code.jquery.com/jquery-1.11.1.min.js"></script>
	<script src="http://code.jquery.com/mobile/1.4.4/jquery.mobile-1.4.4.min.js"></script>
	<style>
		#graphPanel.ui-panel {
			width: 35em;
		}
		
		.arc path {
		  stroke: #fff;
		}
		
		.state {
			fill: none;
			stroke: #fff;
		}

		.state:hover {
			fill-opacity: 0.5;
		}

		#tooltip {
			position: absolute;
			text-align: center;
			padding: 20px;
			margin: 10px;
			font: 12px sans-serif;
			background: lightsteelblue;
			border: 1px;
			border-radius: 2px;
			pointer-events: none;
		}

		#tooltip h4 {
			margin: 0;
			font-size: 14px;
		}

		#tooltip {
			background: rgba(0,0,0,0.9);
			border: 1px solid grey;
			border-radius: 5px;
			font-size: 12px;
			width: auto;
			padding: 4px;
			color: white;
			opacity: 0;
		}

		#tooltip table {
			table-layout: fixed;
		}

		#tooltip tr td {
			padding: 0;
			margin: 0;
		}

		#tooltip tr td:nth-child(1) {
			width: 50px;
		}

		#tooltip tr td:nth-child(2) {
			text-align: center;
		}

		.chart text {
			fill: white;
			font: 12px sans-serif;
			text-anchor: middle;
		}
		
	</style>
</head>

<body>
	<div id = "totalScreen">

		<!-- main screen is the overview page with the maps -->
		<div id = "mainScreen">
			<!-- START: LEFT COLUMN OF OVERVIEW SCREEN -->
			<div id = "leftMainScreen" class = "ui-block-a">
				<h1 style = "text-indent: 7em">SAT/State Education Visualization</h1>

				<!-- top menu with buttons for the comparison screen and various dropdowns -->
				<p style = "margin: 0 auto" align="center">
					<button id = "mainButton" onclick = "showMain()" data-inline = "true">
						Overview
					</button>
					<button id = "comparisonButton" onclick = "showComp()" data-inline = "true">
						Compare
					</button>
					<select id="xdropdown" data-inline = "true">
						<option val=totalScore>totalScore</option>
						<option val=spentPerStudent>spentPerStudent</option>
					</select>
					<button id="update" onclick="updateClicked()" data-inline = "true">
						Update
					</button>
				</p>
				
				<div id="tooltip"></div>
				<svg width="960" height="600" id="statesvg"></svg>
				<script src="lib/d3.js"></script>
				<script src="js/stateBorders.js"></script>
				<script src="js/map.js"></script>

				<script>
					width = 35, barHeight = 35; scores = {}; scale = [];
					states = ["AL", "AK", "AZ", "AR", "CA", "CO", "CT", "DC", "DE", "FL", "GA", "HI", "ID", "IL", "IN", "IA", "KS", "KY", "LA", "ME", "MD", "MA", "MI", "MN", "MS", "MO", "MT", "NE", "NV", "NH", "NJ", "NM", "NY", "NC", "ND", "OH", "OK", "OR", "PA", "RI", "SC", "SD", "TN", "TX", "UT", "VT", "VA", "WA", "WV", "WI", "WY"];

					//default data reading
					updateClicked();

					//functions
					function createScale(min, max) {
						if (min > 100) {
							return [max, Math.round(min + dif * .75), Math.round(min + dif * .5), Math.round(min + dif * .25), min];
						} else {
							return [max.toFixed(1), (min + dif * .75).toFixed(1), (min + dif * .5).toFixed(1), (min + dif * .25).toFixed(1), min.toFixed(1)];
						}
					}
					
					function updateClicked() {
						clearBox("statesvg");
						var e = document.getElementById("xdropdown");
							column = e.options[e.selectedIndex].value;
						d3.csv("res/default.csv", function(error, data) {
							min = parseFloat(d3.min(data, function(d) {return d[column];}));
							max = parseFloat(d3.max(data, function(d) {return d[column];}));
							dif = max - min;
							scale = createScale(min, max);
							for (var index = 0; index < data.length; ++index) {
								data[index][column] = +data[index][column];
								var temp = 255 * (data[index][column] - min) / (max - min);
								scores[states[index]] = {score : data[index][column], color : d3.rgb(0, 0, temp)};
							}
							
							//draw map
							map.draw("#statesvg", scores, tooltip);

							//draw legend
							color = d3.scale.ordinal().range(getColor(scale, min, max));
							svg = d3.select("#statesvg").append("svg").append("g").attr("transform", "translate(0,400)");
							color.domain(scale);
							legend = svg.selectAll(".legend").data(color.domain().slice()).enter().append("g").attr("class", "legend").attr("transform", function(d, i) {return "translate(0," + i * 20 + ")";});
							legend.append("rect").attr("x", width - 18).attr("width", 18).attr("height", 18).style("fill", color);
							legend.append("text").attr("x", width - 24).attr("y", 9).attr("dy", ".35em").style("text-anchor", "end").text(function(d) {return d;});
						});
					}

					function clearBox(elementID){
					    document.getElementById(elementID).innerHTML = "";
					}
					
					function getColor(a, min, max) {
						var ret = [];
						for (var i = 0; i < a.length; i++) {
							ret[i] = d3.rgb(0, 0, 255 * (a[i] - min) / (max - min))
						}
						return ret;
					}

					/* COMMENTED OUT: PANEL FUNCTION
					function addPic() {
						var imgURL = "http://static.tumblr.com/2zujawz/qpVng2o4h/mockup-georgia.jpg";
						var e = document.getElementById("panelPic");
						e.innerHTML = '<p><img src ="' + imgURL + '">';
					}
					*/

					function tooltip(n, d) {
						return "<h4>" + n + "</h4><table><tr><td>Score</td><td>" + (d.score) + "</td></tr></table>";
					}
				</script>
				
			</div>

			<!-- START: RIGHT COLUMN OF OVERVIEW SCREEN -->
			<div id = "rightMainScreen"  class="ui-block-b">
				<h2 style = "text-indent: 8em">STATE NAME HERE:</h2>
				<h4 style = "text-indent: 15em">insert stuff here</h4>
				<div id = "stateNameMainScreen"></div>
				<div id = "stateDonutSchoolMainScreen"></div>
				
				<style>
					body {
					  font: 11px sans-serif;
					}

					.axis path,
					.axis line {
					  fill: none;
					  stroke: #000;
					  shape-rendering: crispEdges;
					}

					.dot {
					  stroke: #000;
					}

					.dot:hover{
					  fill: steelblue;
					}

					.tooltip {
					  position: absolute;
					  width: 200px;
					  height: 28px;
					  pointer-events: none;
					}
				</style>
					
				<script>
					var margin = {top: 20, right: 40, bottom: 30, left: 60},
						width = 960 - margin.left - margin.right,
						height = 500 - margin.top - margin.bottom;

					// setup x 
					var xValue = function(d) { return d.cost;}, // data -> value
						xScale = d3.scale.linear().range([0, width]), // value -> display
						xMap = function(d) { return xScale(xValue(d));}, // data -> display
						xAxis = d3.svg.axis().scale(xScale).orient("bottom");

					// setup y
					var yValue = function(d) { return d.score;}, // data -> value
						yScale = d3.scale.linear().range([height, 0]), // value -> display
						yMap = function(d) { return yScale(yValue(d));}, // data -> display
						yAxis = d3.svg.axis().scale(yScale).orient("left");

					// setup fill color. We can modify this to have color represent a variable
					var cValue = function(d) { return d.score;},
						color = d3.scale.category10();

					// add the graph canvas to the body of the webpage
					var svg = d3.select("#rightMainScreen").append("svg")
						.attr("id", "scatterPlotsvg")
						.attr("width", width + margin.left + margin.right)
						.attr("height", height + margin.top + margin.bottom)
					  .append("g")
						.attr("id", "scatterPlotg")
						.attr("transform", "translate(" + margin.left + "," + margin.top + ")");

					// add the tooltip area to the webpage
					var tooltip1 = d3.select("#rightMainScreen").append("div")
						.attr("class", "tooltip")
						.style("opacity", 0);

					// load data
					d3.csv("res/scatterplotData.csv", function(error, data) {
						
					  // change string (from CSV) into number format
					  data.forEach(function(d) {
						d.cost = +d.cost;
						d.score= +d.score;
					  });

					  // don't want dots overlapping axis, so add in buffer to data domain
					  xScale.domain([d3.min(data, xValue)-1, d3.max(data, xValue)+1]);
					  yScale.domain([d3.min(data, yValue)-1, d3.max(data, yValue)+1]);

					  // x-axis
						d3.select("#scatterPlotg").append("g")
						  .attr("class", "x axis")
						  .attr("transform", "translate(0," + height + ")")
						  .call(xAxis)
						.append("text")
						  .attr("class", "label")
						  .attr("x", width)
						  .attr("y", -6)
						  .style("text-anchor", "end")
						  .text("Educational Cost per Student ($)");
					  // y-axis
						d3.select("#scatterPlotg").append("g")
						  .attr("class", "y axis")
						  .call(yAxis)
						.append("text")
						  .attr("class", "label")
						  .attr("transform", "rotate(-90)")
						  .attr("y", 6)
						  .attr("dy", ".71em")
						  .style("text-anchor", "end")
						  .text("Average State SAT Score");

					  // draw dots
					  d3.select("#scatterPlotg").selectAll(".dot")
						  .data(data)
						.enter().append("circle")
						  .attr("class", "dot")
						  .attr("r", 3.5)
						  .attr("cx", xMap)
						  .attr("cy", yMap)
						  //If we want the color of the dots to be relevant, change this	
						  //.style("fill", function(d) { return color(cValue(d));}) 
						  .on("mouseover", function(d) {
							  tooltip1.transition()
								   .duration(200)
								   .style("opacity", .9);
							  tooltip1.html(d.id + "<br/> (" + xValue(d) 
								+ ", " + yValue(d) + ")")
								   .style("left", (d3.event.pageX + 5) + "px")
								   .style("top", (d3.event.pageY - 28) + "px");
						  })
						  .on("mouseout", function(d) {
							  tooltip1.transition()
								   .duration(500)
								   .style("opacity", 0);
						  });
					});
				</script>
				
				<!-- <img src = 'http://static.tumblr.com/2zujawz/qpVng2o4h/mockup-georgia.jpg'> -->
			</div>
			<!-- END: OVERVIEW SCREEN -->
		</div>
		
		<script>
			//just setting it up so that the main screen (overview screen) is what shows up when page opened
			// but if compare button is clicked, the overview screen is replaced with the comparison screen
			var mainScreen = document.getElementById("mainScreen");
			var compScreen = document.getElementByID("compScreen");

			function showMain() {
				compScreen.style.display = 'none';
				mainScreen.style.display = 'block';
			}

			function showComp() {
				mainScreen.style.display = 'none';
				compScreen.style.display = 'block';
			}
		</script>

		<!-- START: COMPARISON SCREEN -->		
		<div id = "compScreen" class="ui-grid-a">
			<h1 style = "text-indent: 7em">SAT/State Education Visualization</h1>
			<p style = "text-indent: 22em">
				<button id = "mainButton" onclick = "showMain()" data-inline = "true">
					Overview
				</button>
				<button id = "comparisonButton" onclick = "showComp()" data-inline = "true">
					Compare
				</button>
			</p>
			<div class="ui-block-a">
				<img src = 'http://static.tumblr.com/2zujawz/qpVng2o4h/mockup-georgia.jpg'>
			</div>
			<div class="ui-block-b">
				<img src = 'http://static.tumblr.com/2zujawz/qpVng2o4h/mockup-georgia.jpg'>
			</div>
		</div>
		<!-- END: COMPARISON SCREEN -->
	</div>
	<!-- END: ALL DIVS -->

	<script>
		//set compScreen's default to be invisible
		var compScreen = document.getElementById("compScreen");
		compScreen.style.display = 'none';
	</script>
	
</body>
